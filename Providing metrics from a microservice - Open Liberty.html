<!DOCTYPE html>
<html lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Providing metrics from a microservice - Open Liberty</title>
  <meta name="description" content="Open Liberty is the most flexible server runtime available to Earth’s Java developers.">

  <link rel="stylesheet" href="Providing%20metrics%20from%20a%20microservice%20-%20Open%20Liberty_files/bootstrap.css">
  <link type="text/css" rel="stylesheet" href="Providing%20metrics%20from%20a%20microservice%20-%20Open%20Liberty_files/openliberty.css">
  <link type="text/css" rel="stylesheet" href="Providing%20metrics%20from%20a%20microservice%20-%20Open%20Liberty_files/coderay-custom.css">

  
  
  
    <link type="text/css" rel="stylesheet" href="Providing%20metrics%20from%20a%20microservice%20-%20Open%20Liberty_files/guide-card.css">
  
    <link type="text/css" rel="stylesheet" href="Providing%20metrics%20from%20a%20microservice%20-%20Open%20Liberty_files/guide.css">
  

  

  

  <link rel="canonical" href="https://openliberty.io/guides/mp-metrics">
  <link href="Providing%20metrics%20from%20a%20microservice%20-%20Open%20Liberty_files/css.css" rel="stylesheet">
    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@OpenLibertyIO">
  <meta name="twitter:title" content="Open Liberty">
  <meta name="twitter:description" content="Open Liberty is the most flexible server runtime available to Earth’s Java developers.">
  <meta name="twitter:image" content="https://openliberty.io/img/twitter_card.jpg">
  
  <meta name="google-site-verification" content="h2P030H9b66CyL1nEmWfrZB8Fr14h9LmVMG7Ur0caBs">

</head>


  <body>
    
    

    <header>
<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button id="navbar_responsive_button" class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
                      
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right text-right">
                <li class="hidden-xs"><a id="navbar_github_link" href="https://github.com/OpenLiberty" target="new" aria-label="Open Liberty GitHub Repository"></a></li>
            </ul>
        </div>
    </div>
  </nav>
  <div class="hidden">
    <img src="Providing%20metrics%20from%20a%20microservice%20-%20Open%20Liberty_files/small_logo_white.svg">
    <img src="Providing%20metrics%20from%20a%20microservice%20-%20Open%20Liberty_files/github_navbar_hover.svg">
  </div>
</header>


    <main aria-label="Content">

      <div id="background_container" class="black_blue_gradient_background">
    <div class="container">
        <div id="title_row" class="row">
            <div class="col-xs-12">
                <img id="intro_logo" src="Providing%20metrics%20from%20a%20microservice%20-%20Open%20Liberty_files/guides_page_title_small.svg" alt="Guides">
            </div>
        </div>
        <div class="row">
            <!-- Guide's table of contents section -->
            <div id="toc_column" class="col-sm-3">
                <div id="toc_inner">                    
                    
                    <h3 id="toc_title">Contents</h3>
                    <div id="toc_container">
                        <ul class="sectlevel1">
<li><a href="#what-you-ll-learn">What you’ll learn</a></li>
<li><a href="#getting-started">Getting started</a>
<ul class="sectlevel2">
<li><a href="#try-what-you-ll-build">Try what you’ll build</a></li>
</ul>
</li>
<li><a href="#adding-microprofile-metrics-to-inventory-application">Adding Microprofile Metrics to inventory application</a>
<ul class="sectlevel2">
<li><a href="#adding-the-timed-and-counted-annotations">Adding the @timed and @counted annotations</a></li>
<li><a href="#adding-the-gauge-annotation">Adding the @Gauge annotation</a></li>
</ul>
</li>
<li><a href="#building-and-running-the-application">Building and running the application</a></li>
<li><a href="#testing-the-metrics">Testing the metrics</a>
<ul class="sectlevel2">
<li><a href="#running-the-tests">Running the tests</a></li>
</ul>
</li>
<li><a href="#great-work-you-re-done">Great work! You’re done!</a></li>
</ul>
                    </div>

                    
                </div>
            </div>
            <!-- Entire guide section -->
            <div id="guide_column" class="col-sm-9 position_relative">
                <div id="guide_content">
                    <!-- Guide header section -->
                    <div id="guide_meta" class="sect1">
                        <h1 id="guide_title">Providing metrics from a microservice</h1>
                        <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Learn how to provide system and application metrics from a microservice using MicroProfile Metrics.</p>
</div>
</div>
</div><div id="duration_container">
                            <img src="Providing%20metrics%20from%20a%20microservice%20-%20Open%20Liberty_files/guide_duration_clock_icon_large.svg" alt="duration">
                            <span id="guide_duration">20 minutes</span>
                        </div>
                    </div>

                    <!-- Guide content section -->
                    
<div class="sect1">
<h2 id="what-you-ll-learn">What you’ll learn</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You will learn how to use MicroProfile Metrics to provide metrics from a RESTful application.
Having metrics in an application serves to pinpoint issues and provides long term trend data for
capacity planning and pro-active discovery of issues such as disk usage growing without bounds. They can
also help those scheduling systems to decide when to scale the application to run on more or fewer machines.</p>
</div>
<div class="paragraph">
<p>MicroProfile Metrics provides an endpoint where you can get the metrics
results as a plain text format. This endpoint has three scopes: base, application and vendor.
For the purpose of this guide, the focus is on the application scope. The metadata of the metrics in
any scope has fields such as unit, type, description, etc. The type can be a counter, gauge,
meter, histogram and timer. You will use the counter, gauge and timer types in your application.</p>
</div>
<div class="paragraph">
<p>The application that you will be working with is an <code>inventory</code> service, which stores the information
about various JVMs that run on different systems. Whenever a request is made to the <code>inventory</code>
service to retrieve the JVM system properties of a particular host, the <code>inventory</code> service
communicates with the <code>system</code> service on that host to get these system properties.
The system properties are then stored and returned.</p>
</div>
<div class="paragraph">
<p>You will apply the 'metrics type annotations' to the inventory application in order to provide metrics
at the application scope.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started">Getting started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The fastest way to work through this guide is to clone the Git repository and use the starting project
that is provided in the <code>start</code> directory. To do this, run the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git clone https://github.com/OpenLiberty/draft-guide-microprofile-metrics.git
cd draft-guide-microprofile-metrics/start</pre>
</div>
</div>
<div class="sect2">
<h3 id="try-what-you-ll-build">Try what you’ll build</h3>
<div class="paragraph">
<p>The <code>finish</code> directory in the root of this guide contains the finished metrics implementation
for the application. Feel free to give it a try before you proceed with building your own.</p>
</div>
<div class="paragraph">
<p>To try out the application, first navigate to the <code>finish</code> directory and then run the following.
Maven aims to build the application and run it inside Open Liberty:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>mvn install liberty:start-server</code></pre>
</div>
</div>
<div class="paragraph">
<p>Point your browser to <code><a href="http://localhost:9080/inventory/systems" class="bare">http://localhost:9080/inventory/systems</a></code>. As you can see, there are no
hosts registered currently since you have just started the application. Point to
<code><a href="http://localhost:9080/metrics" class="bare">http://localhost:9080/metrics</a></code> MicroProfile Metrics endpoint. Use <code>confAdmin</code> and <code>microprofile</code> as
the credentials to log in. From here, you can see the standard metrics, and also includes
the application metrics, in Prometheus format.
Point to <code><a href="http://localhost:9080/metrics/application" class="bare">http://localhost:9080/metrics/application</a></code> to see application metrics only. The
application metrics will not show up if you do not point your browser first to
<code><a href="http://localhost:9080/inventory/systems" class="bare">http://localhost:9080/inventory/systems</a></code>. This is because these metrics are application related.</p>
</div>
<div class="paragraph">
<p>Once you are done checking out the application, stop the Open Liberty server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>mvn liberty:stop-server</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, navigate back to the <code>start</code> directory to begin.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="adding-microprofile-metrics-to-inventory-application">Adding Microprofile Metrics to inventory application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Begin by navigating to the <code>pom.xml</code> file to check the required dependency. The <code>microprofile-metrics-api</code>
dependency has been added for you in the <code>start/pom.xml</code> file. This dependency allows you to
use the MicroProfile Metrics API to provide the metrics from your RESTful services. Also, the system property <code>javax.net.ssl.trustStore</code> was set for you to point to the SSL certificate.</p>
</div>
<div class="paragraph">
<p>Create <code>start/src/main/liberty/config/server.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;server</span> <span class="attribute-name">description</span>=<span class="string"><span class="delimiter">"</span><span class="content">Sample Liberty server</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>

  <span class="tag">&lt;featureManager&gt;</span>
    <span class="tag">&lt;feature&gt;</span>jaxrs-2.0<span class="tag">&lt;/feature&gt;</span>
    <span class="tag">&lt;feature&gt;</span>jsonp-1.0<span class="tag">&lt;/feature&gt;</span>
    <span class="tag">&lt;feature&gt;</span>cdi-1.2<span class="tag">&lt;/feature&gt;</span>
    <span class="tag">&lt;feature&gt;</span>mpMetrics-1.0<span class="tag">&lt;/feature&gt;</span>
  <span class="tag">&lt;/featureManager&gt;</span>

  <span class="tag">&lt;applicationManager</span> <span class="attribute-name">autoExpand</span>=<span class="string"><span class="delimiter">"</span><span class="content">true</span><span class="delimiter">"</span></span> <span class="tag">/&gt;</span>
  <span class="tag">&lt;quickStartSecurity</span> <span class="attribute-name">userName</span>=<span class="string"><span class="delimiter">"</span><span class="content">confAdmin</span><span class="delimiter">"</span></span> <span class="attribute-name">userPassword</span>=<span class="string"><span class="delimiter">"</span><span class="content">microprofile</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;keyStore</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">"</span><span class="content">defaultKeyStore</span><span class="delimiter">"</span></span> <span class="attribute-name">password</span>=<span class="string"><span class="delimiter">"</span><span class="content">mpKeystore</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>

  <span class="tag">&lt;httpEndpoint</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">"</span><span class="content">*</span><span class="delimiter">"</span></span> <span class="attribute-name">httpPort</span>=<span class="string"><span class="delimiter">"</span><span class="content">${default.http.port}</span><span class="delimiter">"</span></span> <span class="attribute-name">httpsPort</span>=<span class="string"><span class="delimiter">"</span><span class="content">${default.https.port}</span><span class="delimiter">"</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">"</span><span class="content">defaultHttpEndpoint</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>

  <span class="tag">&lt;webApplication</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">"</span><span class="content">io.openliberty.guides.microprofile.metrics.war</span><span class="delimiter">"</span></span> <span class="attribute-name">contextRoot</span>=<span class="string"><span class="delimiter">"</span><span class="content">/</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/server&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>mpMetrics-1.0</code> feature provides <code><a href="http://localhost:9080/metrics" class="bare">http://localhost:9080/metrics</a></code> endpoint.</p>
</div>
<div class="paragraph">
<p>This feature also requires you to secure this endpoint. The <code>quickStartSecurity</code> and <code>keyStore</code>
configurations elements allow you to add a basic security to this application. Use these
credentials to view the metrics endpoint when you browse it.</p>
</div>
<div class="paragraph">
<p>Proceed with the section below to add the metrics using the annotations.</p>
</div>
<div class="sect2">
<h3 id="adding-the-timed-and-counted-annotations">Adding the @timed and @counted annotations</h3>
<div class="paragraph">
<p>Create the class <code>/start/src/main/java/io/openliberty/guides/inventory/InventoryManager.java</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.openliberty.guides.inventory</span>;

<span class="keyword">import</span> <span class="include">java.util.Properties</span>;
<span class="keyword">import</span> <span class="include">io.openliberty.guides.inventory.client.SystemClient</span>;
<span class="keyword">import</span> <span class="include">io.openliberty.guides.inventory.model.InventoryList</span>;
<span class="keyword">import</span> <span class="include">javax.enterprise.context.ApplicationScoped</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.metrics.annotation.Counted</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.metrics.annotation.Timed</span>;

<span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">InventoryManager</span> {

  <span class="directive">private</span> InventoryList invList = <span class="keyword">new</span> InventoryList();
  <span class="directive">private</span> SystemClient systemClient = <span class="keyword">new</span> SystemClient();

  <span class="annotation">@Timed</span>(name = <span class="string"><span class="delimiter">"</span><span class="content">getPropertiesTime</span><span class="delimiter">"</span></span>,
    description = <span class="string"><span class="delimiter">"</span><span class="content">Time needed to get the properties of a system from the given hostname</span><span class="delimiter">"</span></span>)
  <span class="directive">public</span> <span class="predefined-type">Properties</span> get(<span class="predefined-type">String</span> hostname) {
    systemClient.init(hostname);

    <span class="predefined-type">Properties</span> properties = systemClient.getProperties();
    <span class="keyword">if</span> (properties != <span class="predefined-constant">null</span>) {
      invList.addToInventoryList(hostname, properties);
    }
    <span class="keyword">return</span> properties;

  }

  <span class="annotation">@Counted</span>(absolute = <span class="predefined-constant">true</span>, monotonic = <span class="predefined-constant">true</span>,
    description = <span class="string"><span class="delimiter">"</span><span class="content">Number of times the list of systems method is requested</span><span class="delimiter">"</span></span>)
  <span class="directive">public</span> InventoryList list() {
    <span class="keyword">return</span> invList;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, there are two metrics annotations:</p>
</div>
<div class="paragraph">
<p><code>@Timed</code> is a metric annotation that applies on the <code>get()</code> method to track how frequently the method is
invoked and also how long it took for the invocation to complete. Most of the annotations are
followed by fields that correspond to metadata fields and some of them are provided by default
and others are just optional. Timer is a complex metric type comprised of multiple key/values.
The <code>name</code> field sets the name of the metric. If not explicitly given, the name of the annotated
method is used. For the <code>@Timed</code> annotation the default value of <code>unit</code> is <code>seconds</code>. The
<code>description</code> field is optional and it provides a brief description of the purpose of the metric
annotation.</p>
</div>
<div class="paragraph">
<p><code>@Counted</code> is a metric annotation that applies on the <code>list()</code> method to count how many times the list of systems
method is requested. In other words, how many times we display the current contents of the
inventory by going to <code><a href="http://localhost:9080/inventory/systems" class="bare">http://localhost:9080/inventory/systems</a></code>. The <code>absolute</code> field is used to make the name of
this annotation take the name of the method. Like the previous annotation, this annotation has
a <code>description</code> field too. The <code>monotonic</code> field has a default value <code>false</code>
which means that the counter is incremented before the annotated method returns, counting current
invocations of the annotated method. This is not what we want in this case, thus set the value
to <code>true</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="adding-the-gauge-annotation">Adding the @Gauge annotation</h3>
<div class="paragraph">
<p>Create the class <code>/start/src/main/java/io/openliberty/guides/inventory/model/InventoryList.java</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">io.openliberty.guides.inventory.model</span>;

<span class="keyword">import</span> <span class="include">java.util.ArrayList</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;
<span class="keyword">import</span> <span class="include">java.util.Properties</span>;

<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.metrics.MetricUnits</span>;
<span class="keyword">import</span> <span class="include">org.eclipse.microprofile.metrics.annotation.Gauge</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">InventoryList</span> {

  <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">System</span>&gt; systems = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;<span class="predefined-type">System</span>&gt;();

  <span class="directive">public</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">System</span>&gt; getSystems() {
    <span class="keyword">return</span> systems;
  }

  <span class="annotation">@Gauge</span>(unit = MetricUnits.NONE, name = <span class="string"><span class="delimiter">"</span><span class="content">inventorySize</span><span class="delimiter">"</span></span>, description = <span class="string"><span class="delimiter">"</span><span class="content">Number of systems in the inventory</span><span class="delimiter">"</span></span>)
  <span class="directive">public</span> <span class="type">int</span> getTotal() {
    <span class="keyword">return</span> systems.size();
  }

  <span class="directive">public</span> <span class="type">void</span> addToInventoryList(<span class="predefined-type">String</span> hostname, <span class="predefined-type">Properties</span> systemProps) {
    <span class="predefined-type">Properties</span> props = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
    props.setProperty(<span class="string"><span class="delimiter">"</span><span class="content">os.name</span><span class="delimiter">"</span></span>, systemProps.getProperty(<span class="string"><span class="delimiter">"</span><span class="content">os.name</span><span class="delimiter">"</span></span>));
    props.setProperty(<span class="string"><span class="delimiter">"</span><span class="content">user.name</span><span class="delimiter">"</span></span>, systemProps.getProperty(<span class="string"><span class="delimiter">"</span><span class="content">user.name</span><span class="delimiter">"</span></span>));

    <span class="predefined-type">System</span> host = <span class="keyword">new</span> <span class="predefined-type">System</span>(hostname, props);
    <span class="keyword">if</span> (!systems.contains(host))
      systems.add(host);
  }

  <span class="type">class</span> <span class="class">System</span> {

    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> hostname;
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Properties</span> properties;

    <span class="directive">public</span> <span class="predefined-type">System</span>(<span class="predefined-type">String</span> hostname, <span class="predefined-type">Properties</span> properties) {
      <span class="local-variable">this</span>.hostname = hostname;
      <span class="local-variable">this</span>.properties = properties;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getHostname() {
      <span class="keyword">return</span> hostname;
    }

    <span class="directive">public</span> <span class="predefined-type">Properties</span> getProperties() {
      <span class="keyword">return</span> properties;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> equals(<span class="predefined-type">Object</span> host) {
      <span class="keyword">if</span> (host <span class="keyword">instanceof</span> <span class="predefined-type">System</span>) {
        <span class="keyword">return</span> hostname.equals(((<span class="predefined-type">System</span>) host).getHostname());
      }
      <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@Gauge</code> annotation on the <code>getTotal()</code> method tracks the number of systems stored
in the inventory (or tracks the inventory size). A system is stored in the inventory when you visit
<code><a href="http://localhost:9080/inventory/systems/localhost" class="bare">http://localhost:9080/inventory/systems/localhost</a></code>. The <code>unit</code> field must be specified because there
is no default value for this annotation. The <code>name</code> and <code>description</code> are optional like in
the previous two annotations.</p>
</div>
<div class="paragraph">
<p>These three annotations are registered by default to the singleton object <code>MetricRegistry</code>.
Through this object, they send their metadata or metrics to <code><a href="http://localhost:9080/metrics/application" class="bare">http://localhost:9080/metrics/application</a></code>.</p>
</div>
<div class="paragraph">
<p>This application is provided for you in this guide.
If you want to learn how to create a RESTful application, see
<a href="https://openliberty.io/guides/rest-intro.html">Creating a RESTful web service</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="building-and-running-the-application">Building and running the application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To build the application, run the Maven install goal from the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>  mvn install</code></pre>
</div>
</div>
<div class="paragraph">
<p>This goal builds the application and creates a .war file in the target directory and also
configures and installs Open Liberty into the target/liberty/wlp directory.</p>
</div>
<div class="paragraph">
<p>Next, run the Maven liberty:start-server goal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>  mvn liberty:start-server</code></pre>
</div>
</div>
<div class="paragraph">
<p>This goal starts an Open Liberty server instance. Your Maven <code>pom.xml</code> is already configured to
start the application in this server instance.</p>
</div>
<div class="paragraph">
<p>Once the server is running, you can find the metrics endpoint showing useful JVM/server base
details at the following URL:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code><a href="http://localhost:9080/metrics" class="bare">http://localhost:9080/metrics</a></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After you point your browser to <code><a href="http://localhost:9080/inventory/systems" class="bare">http://localhost:9080/inventory/systems</a></code>, you can find specific
metrics about your application at the following URL:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code><a href="http://localhost:9080/metrics/application" class="bare">http://localhost:9080/metrics/application</a></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you make changes to the code, use the Maven package command to rebuild the application and have
the running Open Liberty server pick them up automatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>  mvn package</code></pre>
</div>
</div>
<div class="paragraph">
<p>To stop the Open Liberty server, run the Maven liberty:stop-server goal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>  mvn liberty:stop-server</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing-the-metrics">Testing the metrics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>While you can test your application manually, you should rely on automated tests since they will
trigger a failure whenever a code change introduces a defect. JUnit and the JAX-RS Client API
provide a simple environment for you to write tests.</p>
</div>
<div class="paragraph">
<p>Begin by creating a test class <code>start/src/test/java/it/io/openliberty/guides/metrics/MetricsTest.java</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">it.io.openliberty.guides.metrics</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.Assert</span>.*;

<span class="keyword">import</span> <span class="include">java.io</span>.*;
<span class="keyword">import</span> <span class="include">java.util</span>.*;

<span class="keyword">import</span> <span class="include">javax.ws.rs.client.Client</span>;
<span class="keyword">import</span> <span class="include">javax.ws.rs.client.ClientBuilder</span>;
<span class="keyword">import</span> <span class="include">javax.ws.rs.core.MediaType</span>;
<span class="keyword">import</span> <span class="include">javax.ws.rs.core.Response</span>;

<span class="keyword">import</span> <span class="include">org.apache.cxf.jaxrs.provider.jsrjsonp.JsrJsonpProvider</span>;
<span class="keyword">import</span> <span class="include">org.junit.After</span>;
<span class="keyword">import</span> <span class="include">org.junit.Before</span>;
<span class="keyword">import</span> <span class="include">org.junit.BeforeClass</span>;
<span class="keyword">import</span> <span class="include">org.junit.Test</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">MetricsTest</span> {
  <span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">String</span> port;
  <span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">String</span> baseUrl;

  <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; metrics;
  <span class="directive">private</span> Client client;

  <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> INVENTORY_HOSTS = <span class="string"><span class="delimiter">"</span><span class="content">inventory/systems</span><span class="delimiter">"</span></span>;
  <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> INVENTORY_HOSTNAME = <span class="string"><span class="delimiter">"</span><span class="content">inventory/systems/localhost</span><span class="delimiter">"</span></span>;

  <span class="annotation">@BeforeClass</span>
  <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> oneTimeSetup() {
    port = <span class="predefined-type">System</span>.getProperty(<span class="string"><span class="delimiter">"</span><span class="content">liberty.test.port</span><span class="delimiter">"</span></span>);
    baseUrl = <span class="string"><span class="delimiter">"</span><span class="content">http://localhost:</span><span class="delimiter">"</span></span> + port + <span class="string"><span class="delimiter">"</span><span class="content">/</span><span class="delimiter">"</span></span>;
  }

  <span class="annotation">@Before</span>
  <span class="directive">public</span> <span class="type">void</span> setup() {
    client = ClientBuilder.newClient();
    client.register(JsrJsonpProvider.class);
  }

  <span class="annotation">@After</span>
  <span class="directive">public</span> <span class="type">void</span> teardown() {
    client.close();
  }

  <span class="annotation">@Test</span>
  <span class="directive">public</span> <span class="type">void</span> testSuite() {
    <span class="local-variable">this</span>.testGetPropertiesTime();
    <span class="local-variable">this</span>.testListCount();
    <span class="local-variable">this</span>.testInventorySize();
  }

  <span class="directive">public</span> <span class="type">void</span> testGetPropertiesTime() {
    connectToEndpoint(baseUrl + INVENTORY_HOSTNAME);
    validateMetric(<span class="string"><span class="delimiter">"</span><span class="content">@Timed</span><span class="delimiter">"</span></span>,
                   <span class="string"><span class="delimiter">"</span><span class="content">application:io_openliberty_guides_inventory_inventory_manager_get_properties_time_rate_per_second</span><span class="delimiter">"</span></span>);
  }

  <span class="directive">public</span> <span class="type">void</span> testListCount() {
    connectToEndpoint(baseUrl + INVENTORY_HOSTS);
    validateMetric(<span class="string"><span class="delimiter">"</span><span class="content">@Counted</span><span class="delimiter">"</span></span>, <span class="string"><span class="delimiter">"</span><span class="content">application:list_of_hosts</span><span class="delimiter">"</span></span>);
  }

  <span class="directive">public</span> <span class="type">void</span> testInventorySize() {
    validateMetric(<span class="string"><span class="delimiter">"</span><span class="content">@Gauge</span><span class="delimiter">"</span></span>,
                   <span class="string"><span class="delimiter">"</span><span class="content">application:io_openliberty_guides_inventory_inventory_manager_inventory_size</span><span class="delimiter">"</span></span>);
  }

  <span class="directive">public</span> <span class="type">void</span> validateMetric(<span class="predefined-type">String</span> metricType, <span class="predefined-type">String</span> givenMetric) {
    metrics = getMetrics();
    <span class="keyword">for</span> (<span class="predefined-type">String</span> metric : metrics) {
      <span class="keyword">if</span> (metric.startsWith(givenMetric)) {
        <span class="keyword">if</span> (metricType.equals(<span class="string"><span class="delimiter">"</span><span class="content">@Gauge</span><span class="delimiter">"</span></span>) || metricType.equals(<span class="string"><span class="delimiter">"</span><span class="content">@Counted</span><span class="delimiter">"</span></span>)) {
          assertTrue(<span class="integer">1</span> == <span class="predefined-type">Character</span>.getNumericValue(metric.charAt(metric.length() - <span class="integer">1</span>)));
        } <span class="keyword">else</span> <span class="keyword">if</span> (metricType.equals(<span class="string"><span class="delimiter">"</span><span class="content">@Timed</span><span class="delimiter">"</span></span>)) {
          <span class="type">float</span> seconds = <span class="predefined-type">Float</span>.parseFloat(metric.split(<span class="string"><span class="delimiter">"</span><span class="content"> </span><span class="delimiter">"</span></span>)[<span class="integer">1</span>]);
          assertTrue(<span class="integer">4</span> &gt; seconds);
        }
      }
    }
  }

  <span class="directive">public</span> <span class="type">void</span> connectToEndpoint(<span class="predefined-type">String</span> url) {
    Response response = <span class="local-variable">this</span>.getResponse(url);
    <span class="local-variable">this</span>.assertResponse(url, response);
    response.close();
  }

  <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; getMetrics() {
    Response metricsResponse = client.target(<span class="string"><span class="delimiter">"</span><span class="content">https://localhost:9443/metrics/application</span><span class="delimiter">"</span></span>)
                                     .request(MediaType.TEXT_PLAIN)
                                     .header(<span class="string"><span class="delimiter">"</span><span class="content">Authorization</span><span class="delimiter">"</span></span>,
                                             <span class="string"><span class="delimiter">"</span><span class="content">Basic Y29uZkFkbWluOm1pY3JvcHJvZmlsZQ==</span><span class="delimiter">"</span></span>)
                                     .get();

    <span class="predefined-type">BufferedReader</span> br = <span class="keyword">new</span> <span class="predefined-type">BufferedReader</span>(<span class="keyword">new</span> <span class="predefined-type">InputStreamReader</span>((<span class="predefined-type">InputStream</span>) metricsResponse.getEntity()));
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; result = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;<span class="predefined-type">String</span>&gt;();
    <span class="keyword">try</span> {
      <span class="predefined-type">String</span> input;
      <span class="keyword">while</span> ((input = br.readLine()) != <span class="predefined-constant">null</span>) {
        result.add(input);
      }
      br.close();
    } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
      e.printStackTrace();
      fail();
    }

    metricsResponse.close();
    <span class="keyword">return</span> result;
  }

  <span class="directive">private</span> Response getResponse(<span class="predefined-type">String</span> url) {
    <span class="keyword">return</span> client.target(url).request().get();
  }

  <span class="directive">private</span> <span class="type">void</span> assertResponse(<span class="predefined-type">String</span> url, Response response) {
    assertEquals(<span class="string"><span class="delimiter">"</span><span class="content">Incorrect response code from </span><span class="delimiter">"</span></span> + url, <span class="integer">200</span>, response.getStatus());
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@BeforeClass</code> annotation is placed on a method that executes before any of the test cases. In
this case, the <code>oneTimeSetup()</code> method retrieves the port number for the Open Liberty server and builds
a base URL string that is used throughout the tests.</p>
</div>
<div class="paragraph">
<p>The <code>@Before</code> and <code>@After</code> annotations are placed on methods that execute before and after every
test case. These methods are generally used to perform any setup and teardown tasks.
In this case, the <code>setup()</code> method creates a JAX-RS client which makes HTTP requests to the
inventory service. This client must also be registered with a JSON-P provider (JsrJsonpProvider)
to process JSON resources. The <code>teardown()</code> simply destroys this client instance.</p>
</div>
<div class="paragraph">
<p>Let’s break down the test cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>testGetPropertiesTime()</code> sends a request to <code><a href="http://localhost:9080/inventory/systems/localhost" class="bare">http://localhost:9080/inventory/systems/localhost</a></code>
then verifies the <code>200</code> response code is returned using <code>connectToEndpoint()</code> private method. Next,
it makes a connection to <code><a href="http://localhost:9080/metrics/application" class="bare">http://localhost:9080/metrics/application</a></code> to get the content of the
metrics as a plain text. After that, it asserts if the time needed to get the system properties for
<code>localhost</code> is less than four seconds, using <code>validateMetric()</code> method. This test case tests
<code>@Timed</code> annotation.</p>
</li>
<li>
<p><code>testListCount()</code> sends a request to <code><a href="http://localhost:9080/inventory/systems" class="bare">http://localhost:9080/inventory/systems</a></code> using
<code>connectToEndpoint()</code> method. Next, it asserts if <code>list()</code> method in <code>InventoryManager</code>
class was invoked once using <code>validateMetric()</code> method. This test case tests <code>@Counted</code> annotation.</p>
</li>
<li>
<p><code>testInventorySize()</code> sends a request to <code><a href="http://localhost:9080/inventory/systems/localhost" class="bare">http://localhost:9080/inventory/systems/localhost</a></code> using
<code>connectToEndpoint()</code> method. Because of this request, the inventory grows in size resulting in
<code>getHostCount()</code> method in <code>InventoryManager</code> class to return one host which represent the
localhost. It then asserts that using <code>validateMetric()</code> method.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To force these test cases to execute in a particular order, put them in a <code>testSuite()</code> method and
label it with a <code>@Test</code> annotation so that it automatically executes when your test class run.</p>
</div>
<div class="sect2">
<h3 id="running-the-tests">Running the tests</h3>
<div class="paragraph">
<p>Go to <code>start</code> directory and run <code>mvn clean install</code>. You should see two tests pass with the
following results:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Running it.io.openliberty.guides.metrics.MetricsTest
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 1.778 sec - in it.io.openliberty.guides.metrics.MetricsTest
Running it.io.openliberty.guides.inventory.EndpointTest
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.128 sec - in it.io.openliberty.guides.inventory.EndpointTest

Results :

Tests run: 2, Failures: 0, Errors: 0, Skipped: 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>To see whether the tests detect a failure, change the assertion value(s) in <code>validateMetric()</code> method.
<code>MetricsTest.java</code> file. Re-run the Maven build. You will see a test failure occur.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="great-work-you-re-done">Great work! You’re done!</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You have learned how to provide system and application metrics from microservices. Then you wrote tests to validate that.</p>
</div>
<div class="paragraph">
<p>You can continue to try one of the related guides, which demonstrate new technologies that you can learn and
expand on top what you built in this guide.</p>
</div>
</div>
</div>
                    
                </div>
                <div id="copied_to_clipboard_confirmation" style="display: none;">Copied to clipboard</div>
                <a id="copy_to_clipboard" href="" style="display: none;"></a>
            </div>
        </div>
    </div>
</div>



    </main>

    <footer>
  <div id="footer_container" class="container">
      <div class="row">
          <div class="col-xs-12 text-right">
              <div id="footer_links_container">
                  <a href="https://github.com/OpenLiberty/open-liberty/blob/master/LICENSE" target="new" class="footer_link">License</a>
                  <a href="https://www.ibm.com/privacy/us/en/" target="new" class="footer_link">Privacy policy</a>
                  <a id="footer_twitter_link" href="https://twitter.com/OpenLibertyIO" target="new" aria-label="Twitter"></a>
                  <a id="footer_github_link" href="https://github.com/OpenLiberty" target="new" aria-label="GitHub"></a>
              </div>
              <p id="footer_text">an IBM open source project</p>
              <p id="footer_copyright">© Copyright IBM Corp. 2017</p>
          </div>
      </div>
  </div>
  <div class="hidden">
    <img src="Providing%20metrics%20from%20a%20microservice%20-%20Open%20Liberty_files/footer_twitter_darker.png">
    <img src="Providing%20metrics%20from%20a%20microservice%20-%20Open%20Liberty_files/footer_github_darker.png">
  </div>
</footer>


    <script src="Providing%20metrics%20from%20a%20microservice%20-%20Open%20Liberty_files/jquery.js"></script>
    <script src="Providing%20metrics%20from%20a%20microservice%20-%20Open%20Liberty_files/bootstrap.js"></script>


    

    
      <script type="text/javascript" src="Providing%20metrics%20from%20a%20microservice%20-%20Open%20Liberty_files/guide.js"></script>
    

  


</body></html>
